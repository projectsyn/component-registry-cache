parameters:
  registry_cache:
    =_metadata:
      multi_tenant: true

    namespace: syn-registry-cache

    images:
      registry:
        image: docker.io/library/registry
        tag: 2
      redis:
        registry: docker.io
        repository: library/redis
        tag: '6.2.21'

    replicas: 2
    expose_type: ingress
    fqdn: dockerhub.example.com

    http_secret: '?{vaultkv:${cluster:tenant}/${cluster:name}/registry-cache/http_secret}'
    imagePullSecretName: ~

    redis:
      enabled: true
      resources:
        requests:
          memory: 100Mi
          cpu: 100m
        limits:
          memory: 1Gi
          cpu: 200m
      config: |-
        # Disable persistence entirely
        save ""

    registry:
      resources:
        requests:
          memory: '200Mi'
          cpu: '100m'
        limits:
          memory: '400Mi'
          cpu: '200m'
      config:
        http:
          addr: 0.0.0.0:5000
          host: 'https://${registry_cache:fqdn}'
          secret: '${registry_cache:http_secret}'
        storage:
          delete:
            enabled: true
          s3:
            region: eu-central-1
            regionendpoint: 'https://objects.rma.cloudscale.ch'
            bucket: '${cluster:tenant}-${cluster:name}-registry-mirror-data'
            accesskey: '?{vaultkv:${cluster:tenant}/${cluster:name}/registry-cache/s3_accesskey}'
            secretkey: '?{vaultkv:${cluster:tenant}/${cluster:name}/registry-cache/s3_secretkey}'
        proxy:
          remoteurl: 'https://registry-1.docker.io'
          username: '?{vaultkv:${cluster:tenant}/${cluster:name}/registry-cache/proxy_username}'
          password: '?{vaultkv:${cluster:tenant}/${cluster:name}/registry-cache/proxy_password}'
